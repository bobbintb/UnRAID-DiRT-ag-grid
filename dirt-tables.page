Menu="DiskUtilities"
Title="Deduplication in Real-Time"
Icon="fa-search-minus"
---
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/plugins/bobbintb.system.dirt/nodejs/frontend/css/dirt.css">

<div id="grid-wrapper" style="height: 100%; width: 100%;">
  <div id="myGrid" style="height: 100%; width: 100%;" class="ag-theme-balham"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.3.1/dist/ag-grid-community.min.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/dirt-tables-helpers.js"></script>

<script>
  let socket;
  let gridApi;

  function connect() {
    socket = new WebSocket(`ws://${window.location.hostname}:41820?clientId=dirt-tables.page`);

    socket.onopen = function() {
      console.log("WebSocket connection established.");
      socket.send(JSON.stringify({ action: 'findDuplicates' }));
    };

    socket.onmessage = function(event) {
      const message = JSON.parse(event.data);
      if (message.action === 'duplicateFiles') {
        const { duplicates, state, queue } = message.data;
        initializeGrid(duplicates);
      } else if (message.action === 'removeFile') {
        if (!gridApi) return;
        const { ino } = message.data;

        gridApi.forEachNode(node => {
            if (node.data.fullWidth) return;

            const masterData = node.data;
            if (!masterData.files) return;

            const fileToRemove = masterData.files.find(file => file.ino === ino);

            if (fileToRemove) {
                if (masterData.files.length <= 2) {
                   gridApi.applyTransaction({ remove: [masterData] });
                   const detailId = masterData.hash + '_detail';
                   const detailNode = gridApi.getRowNode(detailId);
                   if (detailNode) {
                       gridApi.applyTransaction({ remove: [detailNode.data] });
                   }
                } else {
                   masterData.files = masterData.files.filter(file => file.ino !== ino);
                   masterData.count = masterData.files.length;
                   masterData.totalSize = masterData.totalSize - fileToRemove.size;
                   gridApi.applyTransaction({ update: [masterData] });

                   const detailId = masterData.hash + '_detail';
                   const detailNode = gridApi.getRowNode(detailId);
                   if (detailNode) {
                       detailNode.data.count = masterData.count;
                       detailNode.data.totalSize = masterData.totalSize;

                       gridApi.resetRowHeights();
                       gridApi.refreshCells({ rowNodes: [detailNode], force: true });
                   }
                }
            }
        });
      }
    };

    socket.onclose = function(event) {
      console.log("WebSocket connection closed. Reconnecting in 1 second...");
      setTimeout(function() {
        connect();
      }, 1000);
    };

    socket.onerror = function(error) {
      console.error("WebSocket error: ", error);
      socket.close();
    };
  }

  function initializeGrid(initialData) {

    const rowData = [];
    initialData.forEach(master => {
        master.expanded = true;
        rowData.push(master);
        rowData.push({
            fullWidth: true,
            masterData: master,
            hash: master.hash + '_detail',
            count: master.count,
            totalSize: master.totalSize
        });
    });

    const customComparator = (valueA, valueB, nodeA, nodeB, isDescending) => {
        const getHash = (node) => node.data.fullWidth ? node.data.masterData.hash : node.data.hash;
        const hashA = getHash(nodeA);
        const hashB = getHash(nodeB);

        if (hashA !== hashB) {
             if (valueA === valueB) {
                 // Secondary sort by Hash to keep groups together
                 // This ensures that if values are equal, rows with the same hash stay together
                 return hashA > hashB ? 1 : -1;
             }
             return valueA > valueB ? 1 : -1;
        } else {
             const isAMaster = !nodeA.data.fullWidth;
             const isBMaster = !nodeB.data.fullWidth;

             if (isAMaster && !isBMaster) return isDescending ? 1 : -1;
             if (!isAMaster && isBMaster) return isDescending ? -1 : 1;
             return 0;
        }
    };

    function actionCellRenderer(params) {
      const eGui = document.createElement('div');
      eGui.innerHTML = `
        <button class="action-icon" data-action="delete"><i class="fa fa-trash"></i></button>
        <button class="action-icon" data-action="link"><i class="fa fa-link"></i></button>
      `;

      const buttons = eGui.querySelectorAll('.action-icon');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const action = button.dataset.action;
          const newAction = params.data.action === action ? null : action;
          params.node.setDataValue('action', newAction);
        });
      });

      if (params.data.action) {
        const selectedButton = eGui.querySelector(`[data-action="${params.data.action}"]`);
        if (selectedButton) {
          selectedButton.classList.add('selected');
        }
      }

      return eGui;
    }

    class ActionHeaderComponent {
      init(params) {
        this.params = params;
        this.eGui = document.createElement('div');
        this.eGui.innerHTML = `
          <button class="action-icon" data-action="delete"><i class="fa fa-trash"></i></button>
          <button class="action-icon" data-action="link"><i class="fa fa-link"></i></button>
        `;

        this.updateHeaderState = this.updateHeaderState.bind(this);
        this.params.api.addEventListener('cellValueChanged', this.updateHeaderState);
        this.params.api.addEventListener('firstDataRendered', this.updateHeaderState);


        this.eGui.querySelectorAll('.action-icon').forEach(button => {
          button.addEventListener('click', () => {
            const action = button.dataset.action;
            const detailGridApi = this.params.api;

            let allSelected = true;
            detailGridApi.forEachNode(rowNode => {
              if (rowNode.data.action !== action) {
                allSelected = false;
              }
            });

            const newAction = allSelected ? null : action;

            detailGridApi.forEachNode(rowNode => {
              rowNode.setDataValue('action', newAction);
            });
          });
        });
      }

      updateHeaderState() {
        const detailGridApi = this.params.api;
        if (detailGridApi.getDisplayedRowCount() === 0) return;

        let firstAction = detailGridApi.getDisplayedRowAtIndex(0).data.action;
        let allSame = true;

        detailGridApi.forEachNode(rowNode => {
          if (rowNode.data.action !== firstAction) {
            allSame = false;
          }
        });

        const trashIcon = this.eGui.querySelector('[data-action="delete"]');
        const linkIcon = this.eGui.querySelector('[data-action="link"]');

        trashIcon.classList.remove('selected');
        linkIcon.classList.remove('selected');

        if (allSame && firstAction) {
          if (firstAction === 'delete') {
            trashIcon.classList.add('selected');
          } else if (firstAction === 'link') {
            linkIcon.classList.add('selected');
          }
        }
      }

      getGui() {
        return this.eGui;
      }

      destroy() {
        if (this.params && this.params.api) {
          this.params.api.removeEventListener('cellValueChanged', this.updateHeaderState);
          this.params.api.removeEventListener('firstDataRendered', this.updateHeaderState);
        }
      }
    }

    class MasterCellRenderer {
        init(params) {
            this.params = params;
            this.eGui = document.createElement('div');
            this.eGui.style.display = 'flex';
            this.eGui.style.alignItems = 'center';

            this.eIcon = document.createElement('span');
            this.eIcon.innerHTML = params.data.expanded ? '<i class="fa fa-minus-square-o"></i>' : '<i class="fa fa-plus-square-o"></i>';
            this.eIcon.className = 'master-expand-icon';
            this.eIcon.style.cursor = 'pointer';
            this.eIcon.style.marginRight = '8px';

            this.eValue = document.createElement('span');
            this.eValue.innerText = params.value;

            this.eGui.appendChild(this.eIcon);
            this.eGui.appendChild(this.eValue);

            this.eIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                this.onExpandClicked();
            });
        }

        getGui() { return this.eGui; }

        onExpandClicked() {
            const rowNode = this.params.node;
            const data = rowNode.data;
            const api = this.params.api;

            if (data.expanded) {
                // Collapse
                data.expanded = false;
                this.eIcon.innerHTML = '<i class="fa fa-plus-square-o"></i>';

                const detailId = data.hash + '_detail';
                const detailNode = api.getRowNode(detailId);
                if (detailNode) {
                    api.applyTransaction({ remove: [detailNode.data] });
                }
            } else {
                // Expand
                data.expanded = true;
                this.eIcon.innerHTML = '<i class="fa fa-minus-square-o"></i>';

                const detailRow = {
                    fullWidth: true,
                    masterData: data,
                    hash: data.hash + '_detail',
                    count: data.count,
                    totalSize: data.totalSize
                };

                api.applyTransaction({ add: [detailRow], addIndex: rowNode.rowIndex + 1 });
            }
        }
    }

    class DetailCellRenderer {
        init(params) {
            this.eGui = document.createElement('div');
            this.eGui.style.width = '100%';
            this.eGui.style.height = '100%';
            this.eGui.classList.add('detail-grid-wrapper');
            this.eGui.style.borderTop = '1px solid #bdc3c7';
            this.eGui.style.backgroundColor = '#f5f7f7';
            this.eGui.style.padding = '10px';
            this.eGui.style.boxSizing = 'border-box';

            const masterData = params.data.masterData;

            const detailGridOptions = {
                rowData: masterData.files,
                components: {
                    actionCellRenderer: actionCellRenderer,
                    actionHeaderComponent: ActionHeaderComponent,
                },
                defaultColDef: {
                    suppressHeaderMenuButton: true,
                    suppressHeaderContextMenu: true,
                },
                getRowId: params => params.data.ino,
                columnDefs: [
                    {
                        headerName: '',
                        width: 45,
                        cellRenderer: (detailParams) => {
                            const input = document.createElement('input');
                            input.type = 'radio';
                            input.name = `radio-group-${masterData.hash}`;
                            input.checked = detailParams.data.is_original;
                            input.addEventListener('change', () => {
                                if (input.checked) {
                                    socket.send(JSON.stringify({
                                        action: 'setOriginalFile',
                                        data: {
                                            hash: masterData.hash,
                                            ino: detailParams.data.ino,
                                        },
                                    }));
                                }
                            });
                            return input;
                        },
                    },
                    {
                        headerName: '',
                        field: 'action',
                        width: 70,
                        cellRenderer: 'actionCellRenderer',
                        headerComponent: 'actionHeaderComponent',
                    },
                    { field: 'path', headerName: 'Path', flex: 1 },
                    {
                        field: 'size',
                        headerName: 'Size',
                        width: 85,
                        valueFormatter: params => formatBytes(params.value)
                    },
                    {
                        field: 'mtime',
                        headerName: 'Modified',
                        width: 185,
                        valueFormatter: params => new Date(params.value).toLocaleString()
                    },
                    {
                        field: 'ctime',
                        headerName: 'Created',
                        width: 185,
                        valueFormatter: params => new Date(params.value).toLocaleString()
                    }
                ]
            };

            this.detailGridApi = agGrid.createGrid(this.eGui, detailGridOptions);
        }

        getGui() { return this.eGui; }

        destroy() {
            if (this.detailGridApi) {
                this.detailGridApi.destroy();
            }
        }

        refresh(params) {
            return false;
        }
    }

    const gridOptions = {
      columnDefs: [
        {
            field: 'hash',
            headerName: 'Hash',
            cellRenderer: MasterCellRenderer,
            width: 350,
            comparator: customComparator
        },
        {
            field: 'count',
            headerName: 'Count',
            width: 71,
            comparator: customComparator
        },
        {
          field: 'totalSize',
          headerName: 'Freeable',
          width: 90,
          valueFormatter: params => formatBytes(params.value),
          comparator: customComparator
        }
      ],
      rowData: rowData,
      onGridReady: (params) => {
        gridApi = params.api;
      },
      getRowId: params => {
          if (params.data.fullWidth) return params.data.hash;
          return params.data.hash;
      },
      isFullWidthRow: params => params.rowNode.data.fullWidth,
      fullWidthCellRenderer: DetailCellRenderer,
      getRowHeight: params => {
          if (params.node.data.fullWidth) {
               const count = params.data.masterData.files.length;
               return (count * 28) + 33 + 60;
          }
          return 28;
      },
      defaultColDef: {
        suppressHeaderMenuButton: true,
        suppressHeaderContextMenu: true,
      },
      groupDefaultExpanded: -1,
      embedFullWidthRows: true,
    };

    const gridDiv = document.querySelector('#myGrid');
    agGrid.createGrid(gridDiv, gridOptions);
  }

  function setGridHeight() {
    const gridWrapper = document.querySelector('#grid-wrapper');
    const offsetTop = gridWrapper.offsetTop;
    const viewportHeight = window.innerHeight;
    const buffer = 30;
    gridWrapper.style.height = `${viewportHeight - offsetTop - buffer}px`;
  }

  document.addEventListener('DOMContentLoaded', function() {
    setGridHeight();
    window.addEventListener('resize', setGridHeight);
    connect();
  });
</script>
