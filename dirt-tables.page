Menu="DiskUtilities"
Title="Deduplication in Real-Time"
Icon="fa-search-minus"
---
<style>
  .action-button {
    background-color: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
  }

  .action-button.selected {
    color: #007bff; /* a shade of blue */
  }

  .action-button-header {
    background-color: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
  }
</style>
<div id="grid-wrapper" style="height: 100%; width: 100%;">
  <div id="myGrid" style="height: 100%; width: 100%;" class="ag-theme-balham"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.3.1/dist/ag-grid-enterprise.min.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/dirt-tabulator-helpers.js"></script>

<script>
  let socket;

  class ActionHeader {
    init(params) {
      this.params = params;
      this.eGui = document.createElement('div');

      const linkButton = document.createElement('button');
      linkButton.classList.add('action-button-header');
      linkButton.innerHTML = '<i class="fa fa-link"></i>';
      linkButton.addEventListener('click', () => {
        this.params.api.forEachNode(rowNode => {
          const cell = this.params.api.getCellRendererInstances({ rowNode, colKey: 'action' })[0];
          if (cell) {
            const button = cell.eGui.querySelector('.fa-link').parentElement;
            const currentlySelected = cell.eGui.querySelector('.selected');
            if (currentlySelected && currentlySelected !== button) {
              currentlySelected.classList.remove('selected');
            }
            button.classList.toggle('selected');
          }
        });
      });

      const trashButton = document.createElement('button');
      trashButton.classList.add('action-button-header');
      trashButton.innerHTML = '<i class="fa fa-trash"></i>';
      trashButton.addEventListener('click', () => {
        this.params.api.forEachNode(rowNode => {
          const cell = this.params.api.getCellRendererInstances({ rowNode, colKey: 'action' })[0];
          if (cell) {
            const button = cell.eGui.querySelector('.fa-trash').parentElement;
            const currentlySelected = cell.eGui.querySelector('.selected');
            if (currentlySelected && currentlySelected !== button) {
              currentlySelected.classList.remove('selected');
            }
            button.classList.toggle('selected');
          }
        });
      });

      this.eGui.appendChild(linkButton);
      this.eGui.appendChild(trashButton);
    }

    getGui() {
      return this.eGui;
    }
  }

  function connect() {
    socket = new WebSocket(`ws://${window.location.hostname}:41820?clientId=dirt-tables.page`);

    socket.onopen = function() {
      console.log("WebSocket connection established.");
      socket.send(JSON.stringify({ action: 'findDuplicates' }));
    };

    socket.onmessage = function(event) {
      const message = JSON.parse(event.data);
      if (message.action === 'duplicateFiles') {
        const { duplicates, state, queue } = message.data;
        initializeGrid(duplicates);
      }
    };

    socket.onclose = function(event) {
      console.log("WebSocket connection closed. Reconnecting in 1 second...");
      setTimeout(function() {
        connect();
      }, 1000);
    };

    socket.onerror = function(error) {
      console.error("WebSocket error: ", error);
      socket.close();
    };
  }

  function initializeGrid(data) {
    const gridOptions = {
      columnDefs: [
        { field: 'hash', headerName: 'Hash', cellRenderer: 'agGroupCellRenderer' },
        { field: 'count', headerName: 'Count' },
        {
          field: 'totalSize',
          headerName: 'Reclaimable Space',
          valueFormatter: params => formatBytes(params.value)
        }
      ],
      rowData: data,
      masterDetail: true,
      autoSizeStrategy: {
        type: 'fitCellContents',
      },
      groupDefaultExpanded: -1,
      detailRowAutoHeight: true,
      defaultColDef: {
        suppressMenu: true,
      },
      detailCellRendererParams: (masterParams) => {
        return {
          detailGridOptions: {
            components: {
              actionHeader: ActionHeader,
            },
            autoSizeStrategy: {
              type: 'fitCellContents',
            },
            defaultColDef: {
              suppressMenu: true,
            },
            columnDefs: [
              {
                headerName: '',
                width: 50,
                cellRenderer: (detailParams) => {
                  const input = document.createElement('input');
                  input.type = 'radio';
                  input.name = `radio-group-${masterParams.data.hash}`;
                  input.checked = detailParams.node.rowIndex === 0;
                  return input;
                },
              },
              {
                field: 'action',
                headerName: '',
                width: 100,
                headerComponent: 'actionHeader',
                cellRenderer: (params) => {
                  const container = document.createElement('div');

                  const linkButton = document.createElement('button');
                  linkButton.classList.add('action-button');
                  linkButton.innerHTML = '<i class="fa fa-link"></i>';
                  linkButton.addEventListener('click', () => {
                    const currentlySelected = container.querySelector('.selected');
                    if (currentlySelected && currentlySelected !== linkButton) {
                      currentlySelected.classList.remove('selected');
                    }
                    linkButton.classList.toggle('selected');
                  });

                  const trashButton = document.createElement('button');
                  trashButton.classList.add('action-button');
                  trashButton.innerHTML = '<i class="fa fa-trash"></i>';
                  trashButton.addEventListener('click', () => {
                    const currentlySelected = container.querySelector('.selected');
                    if (currentlySelected && currentlySelected !== trashButton) {
                      currentlySelected.classList.remove('selected');
                    }
                    trashButton.classList.toggle('selected');
                  });

                  container.appendChild(linkButton);
                  container.appendChild(trashButton);

                  return container;
                }
              },
              { field: 'path', headerName: 'Path' },
              {
                field: 'size',
                headerName: 'Size',
                valueFormatter: params => formatBytes(params.value)
              },
              {
                field: 'mtime',
                headerName: 'Modified',
                valueFormatter: params => new Date(params.value).toLocaleString()
              },
              {
                field: 'ctime',
                headerName: 'Created',
                valueFormatter: params => new Date(params.value).toLocaleString()
              }
            ]
          },
          getDetailRowData: (params) => {
            params.successCallback(params.data.files);
          },
        }
      }
    };

    const gridDiv = document.querySelector('#myGrid');
    new agGrid.Grid(gridDiv, gridOptions);
  }

  function setGridHeight() {
    const gridWrapper = document.querySelector('#grid-wrapper');
    const offsetTop = gridWrapper.offsetTop;
    const viewportHeight = window.innerHeight;
    const buffer = 30; // an arbitrary buffer
    gridWrapper.style.height = `${viewportHeight - offsetTop - buffer}px`;
  }

  document.addEventListener('DOMContentLoaded', function() {
    setGridHeight();
    window.addEventListener('resize', setGridHeight);
    connect();
  });
</script>
