Menu="DiskUtilities"
Title="Deduplication in Real-Time"
Icon="fa-search-minus"
---
<div id="grid-wrapper" style="height: 100%; width: 100%;">
  <div id="myGrid" style="height: 100%; width: 100%;" class="ag-theme-balham"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@34.3.1/dist/ag-grid-enterprise.min.js"></script>
<script src="/plugins/bobbintb.system.dirt/nodejs/frontend/dirt-tabulator-helpers.js"></script>

<script>
  let socket;

  function connect() {
    socket = new WebSocket(`ws://${window.location.hostname}:41820?clientId=dirt-tables.page`);

    socket.onopen = function() {
      console.log("WebSocket connection established.");
      socket.send(JSON.stringify({ action: 'findDuplicates' }));
    };

    socket.onmessage = function(event) {
      const message = JSON.parse(event.data);
      if (message.action === 'duplicateFiles') {
        const { duplicates, state, queue } = message.data;
        initializeGrid(duplicates);
      }
    };

    socket.onclose = function(event) {
      console.log("WebSocket connection closed. Reconnecting in 1 second...");
      setTimeout(function() {
        connect();
      }, 1000);
    };

    socket.onerror = function(error) {
      console.error("WebSocket error: ", error);
      socket.close();
    };
  }

  function initializeGrid(data) {
    const gridOptions = {
      columnDefs: [
        { field: 'hash', headerName: 'Hash', cellRenderer: 'agGroupCellRenderer', width: 350 },
        { field: 'count', headerName: 'Count', width: 71 },
        {
          field: 'totalSize',
          headerName: 'Freeable',
          width: 90,
          valueFormatter: params => formatBytes(params.value)
        }
      ],
      rowData: data,
      masterDetail: true,
      groupDefaultExpanded: -1,
      detailRowAutoHeight: true,
      defaultColDef: {
        suppressHeaderMenuButton: true,
        suppressHeaderContextMenu: true,
      },
      detailCellRendererParams: (masterParams) => {
        return {
          detailGridOptions: {
            defaultColDef: {
              suppressHeaderMenuButton: true,
              suppressHeaderContextMenu: true,
            },
            columnDefs: [
              {
                headerName: '',
                width: 45,
                cellRenderer: (detailParams) => {
                  const input = document.createElement('input');
                  input.type = 'radio';
                  input.name = `radio-group-${masterParams.data.hash}`;
                  input.checked = detailParams.node.rowIndex === 0;
                  return input;
                },
              },
              { field: 'path', headerName: 'Path', flex: 1 },
              {
                field: 'size',
                headerName: 'Size',
                width: 85,
                valueFormatter: params => formatBytes(params.value)
              },
              {
                field: 'mtime',
                headerName: 'Modified',
                width: 185,
                valueFormatter: params => new Date(params.value).toLocaleString()
              },
              {
                field: 'ctime',
                headerName: 'Created',
                width: 185,
                valueFormatter: params => new Date(params.value).toLocaleString()
              }
            ]
          },
          getDetailRowData: (params) => {
            params.successCallback(params.data.files);
          },
        }
      }
    };

    const gridDiv = document.querySelector('#myGrid');
    agGrid.createGrid(gridDiv, gridOptions);
  }

  function setGridHeight() {
    const gridWrapper = document.querySelector('#grid-wrapper');
    const offsetTop = gridWrapper.offsetTop;
    const viewportHeight = window.innerHeight;
    const buffer = 30; // an arbitrary buffer
    gridWrapper.style.height = `${viewportHeight - offsetTop - buffer}px`;
  }

  document.addEventListener('DOMContentLoaded', function() {
    setGridHeight();
    window.addEventListener('resize', setGridHeight);
    connect();
  });
</script>
